{% extends "admin_base.html" %}

{% block title %}Dashboard - JobSprint{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-tachometer-alt me-2"></i>My Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('user_preferences') }}" class="btn btn-primary">
            <i class="fas fa-cog me-2"></i>Edit Preferences
        </a>
    </div>
</div>

<!-- Welcome Message -->
<div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Welcome, {{ user.name }}!</strong> Your job automation system is ready to find opportunities for you.
</div>

<!-- Current Preferences Summary -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>Search Preferences</h5>
            </div>
            <div class="card-body">
                {% if preferences %}
                <dl class="row mb-0">
                    <dt class="col-sm-5">Keywords:</dt>
                    <dd class="col-sm-7">
                        {% for keyword in preferences.keywords[:3] %}
                            <span class="badge bg-primary me-1">{{ keyword }}</span>
                        {% endfor %}
                        {% if preferences.keywords|length > 3 %}
                            <small class="text-muted">+{{ (preferences.keywords|length) - 3 }} more</small>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-5">Locations:</dt>
                    <dd class="col-sm-7">
                        {% for location in preferences.locations[:2] %}
                            <span class="badge bg-info me-1">{{ location }}</span>
                        {% endfor %}
                        {% if preferences.locations|length > 2 %}
                            <small class="text-muted">+{{ (preferences.locations|length) - 2 }} more</small>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-5">Min Salary:</dt>
                    <dd class="col-sm-7">${{ "{:,}".format(preferences.min_salary) }}</dd>
                    
                    <dt class="col-sm-5">Search Frequency:</dt>
                    <dd class="col-sm-7">Every {{ preferences.search_frequency_minutes }} minutes</dd>
                </dl>
                {% else %}
                <p class="text-muted">No preferences set. <a href="{{ url_for('user_preferences') }}">Set up your preferences</a> to get started.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>System Settings</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">Account Status:</dt>
                    <dd class="col-sm-6">
                        {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Subscription:</dt>
                    <dd class="col-sm-6">
                        <span class="badge bg-info">{{ user.subscription_tier.title() }}</span>
                    </dd>
                    
                    <dt class="col-sm-6">LinkedIn Quality:</dt>
                    <dd class="col-sm-6">
                        {% if preferences %}
                            {{ preferences.linkedin_quality_threshold }}/100
                        {% else %}
                            Not set
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Job Sources:</dt>
                    <dd class="col-sm-6">
                        {% if preferences and preferences.sites_enabled %}
                            {% for site in preferences.sites_enabled[:2] %}
                                <span class="badge bg-secondary me-1">{{ site.title() }}</span>
                            {% endfor %}
                            {% if preferences.sites_enabled|length > 2 %}
                                <small class="text-muted">+{{ (preferences.sites_enabled|length) - 2 }}</small>
                            {% endif %}
                        {% else %}
                            Not configured
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('user_preferences') }}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i>Update Preferences
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-success" onclick="testJobSearch()">
                                <i class="fas fa-search me-2"></i>Test Job Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('user_job_history') }}" class="btn btn-outline-info">
                                <i class="fas fa-history me-2"></i>View Job History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Your job automation system is active and monitoring for new opportunities.
                </div>
                
                {% if preferences %}
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Next search will run in approximately {{ preferences.search_frequency_minutes }} minutes.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testJobSearch() {
    const button = event.target;
    const originalText = button.innerHTML;

    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    button.disabled = true;

    fetch('/user/test-search', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ Test Search Results:\n\nFound ${data.jobs_count} jobs for "${data.keyword}" in "${data.location}"\n\n${data.message}`);
        } else {
            alert(`❌ Test Search Failed:\n\n${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error running test search. Please check your preferences and try again.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
