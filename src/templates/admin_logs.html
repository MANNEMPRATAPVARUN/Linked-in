{% extends "admin_base.html" %}

{% block title %}System Logs - JobSprint{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-file-alt me-2"></i>System Logs</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-success" onclick="testScraper()">
                <i class="fas fa-flask"></i> Test Scraper
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="refreshLogs()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAutoRefresh()">
                <i class="fas fa-play" id="autoRefreshIcon"></i> <span id="autoRefreshText">Start Auto-Refresh</span>
            </button>
        </div>
    </div>
</div>

<!-- Log Filters -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="logFilter" placeholder="Filter logs..." onkeyup="filterLogs()">
        </div>
    </div>
    <div class="col-md-6">
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="logLevel" id="logAll" value="all" checked>
            <label class="btn btn-outline-secondary" for="logAll">All</label>
            
            <input type="radio" class="btn-check" name="logLevel" id="logInfo" value="INFO">
            <label class="btn btn-outline-info" for="logInfo">Info</label>
            
            <input type="radio" class="btn-check" name="logLevel" id="logWarning" value="WARNING">
            <label class="btn btn-outline-warning" for="logWarning">Warning</label>
            
            <input type="radio" class="btn-check" name="logLevel" id="logError" value="ERROR">
            <label class="btn btn-outline-danger" for="logError">Error</label>
        </div>
    </div>
</div>

<!-- Status Indicators -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="fas fa-eye fa-2x text-info mb-2"></i>
                <h6>Monitoring Status</h6>
                <span class="badge bg-success" id="monitoringStatus">Active</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <i class="fas fa-search fa-2x text-primary mb-2"></i>
                <h6>Search Engine</h6>
                <span class="badge bg-secondary" id="searchEngineStatus">Unknown</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <i class="fas fa-database fa-2x text-success mb-2"></i>
                <h6>Log Entries</h6>
                <span class="badge bg-info" id="logCount">0</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h6>Last Update</h6>
                <small id="lastUpdate">Never</small>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Logs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Real-time System Logs</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="scrollToBottom" checked>
                    <label class="form-check-label" for="scrollToBottom">Auto-scroll</label>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="logContainer" style="height: 600px; overflow-y: auto; background: #1e1e1e; color: #fff; font-family: 'Courier New', monospace; font-size: 12px;">
                    <div class="p-3">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading system logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Analysis -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Log Analysis</h5>
            </div>
            <div class="card-body">
                <div id="logAnalysis">
                    <p class="text-muted">Log analysis will appear here after loading logs...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="testScraper()">
                        <i class="fas fa-flask me-2"></i>Test LinkedIn Scraper
                    </button>
                    <button class="btn btn-outline-info" onclick="clearLogs()">
                        <i class="fas fa-trash me-2"></i>Clear Log Display
                    </button>
                    <button class="btn btn-outline-success" onclick="exportLogs()">
                        <i class="fas fa-download me-2"></i>Export Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval = null;
let isAutoRefreshing = false;

function refreshLogs() {
    fetch('/admin/logs/api')
        .then(response => response.json())
        .then(logs => {
            displayLogs(logs);
            updateLogAnalysis(logs);
            updateStatus(logs.length);
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            document.getElementById('logContainer').innerHTML = `
                <div class="p-3 text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading logs: ${error.message}
                </div>
            `;
        });
}

function displayLogs(logs) {
    const container = document.getElementById('logContainer');
    const shouldScroll = document.getElementById('scrollToBottom').checked;
    
    let html = '<div class="p-2">';
    
    logs.forEach(log => {
        const logLevel = getLogLevel(log.content);
        const logColor = getLogColor(logLevel);
        const timestamp = log.content.substring(0, 19);
        const message = log.content.substring(19);
        
        html += `
            <div class="log-entry mb-1" data-level="${logLevel}" data-file="${log.file}">
                <span style="color: #888;">[${log.file}]</span>
                <span style="color: #666;">${timestamp}</span>
                <span style="color: ${logColor};">${message}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    if (shouldScroll) {
        container.scrollTop = container.scrollHeight;
    }
    
    // Apply current filter
    filterLogs();
}

function getLogLevel(content) {
    if (content.includes('ERROR')) return 'ERROR';
    if (content.includes('WARNING')) return 'WARNING';
    if (content.includes('INFO')) return 'INFO';
    return 'DEBUG';
}

function getLogColor(level) {
    switch (level) {
        case 'ERROR': return '#ff6b6b';
        case 'WARNING': return '#feca57';
        case 'INFO': return '#48dbfb';
        default: return '#fff';
    }
}

function filterLogs() {
    const filterText = document.getElementById('logFilter').value.toLowerCase();
    const selectedLevel = document.querySelector('input[name="logLevel"]:checked').value;
    const entries = document.querySelectorAll('.log-entry');
    
    entries.forEach(entry => {
        const content = entry.textContent.toLowerCase();
        const level = entry.dataset.level;
        
        const matchesText = !filterText || content.includes(filterText);
        const matchesLevel = selectedLevel === 'all' || level === selectedLevel;
        
        entry.style.display = matchesText && matchesLevel ? 'block' : 'none';
    });
}

function updateLogAnalysis(logs) {
    const analysis = {
        total: logs.length,
        errors: logs.filter(log => log.content.includes('ERROR')).length,
        warnings: logs.filter(log => log.content.includes('WARNING')).length,
        info: logs.filter(log => log.content.includes('INFO')).length,
        searches: logs.filter(log => log.content.includes('SEARCHING')).length,
        jobsFound: logs.filter(log => log.content.includes('jobs found')).length
    };
    
    document.getElementById('logAnalysis').innerHTML = `
        <dl class="row mb-0">
            <dt class="col-sm-6">Total Entries:</dt>
            <dd class="col-sm-6">${analysis.total}</dd>
            
            <dt class="col-sm-6">Errors:</dt>
            <dd class="col-sm-6"><span class="badge bg-danger">${analysis.errors}</span></dd>
            
            <dt class="col-sm-6">Warnings:</dt>
            <dd class="col-sm-6"><span class="badge bg-warning">${analysis.warnings}</span></dd>
            
            <dt class="col-sm-6">Job Searches:</dt>
            <dd class="col-sm-6"><span class="badge bg-info">${analysis.searches}</span></dd>
        </dl>
    `;
}

function updateStatus(logCount) {
    document.getElementById('logCount').textContent = logCount;
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

function toggleAutoRefresh() {
    if (isAutoRefreshing) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshing = false;
        document.getElementById('autoRefreshIcon').className = 'fas fa-play';
        document.getElementById('autoRefreshText').textContent = 'Start Auto-Refresh';
    } else {
        autoRefreshInterval = setInterval(refreshLogs, 5000); // Refresh every 5 seconds
        isAutoRefreshing = true;
        document.getElementById('autoRefreshIcon').className = 'fas fa-pause';
        document.getElementById('autoRefreshText').textContent = 'Stop Auto-Refresh';
    }
}

function testScraper() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    button.disabled = true;
    
    fetch('/admin/test-scraper')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Scraper Test Results:\n\nFound ${data.jobs_found} real jobs!\n\nSample job: "${data.jobs[0]?.title}" at "${data.jobs[0]?.company}"\n\n${data.message}`);
            } else {
                alert(`❌ Scraper Test Failed:\n\n${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error testing scraper');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function clearLogs() {
    document.getElementById('logContainer').innerHTML = `
        <div class="p-3 text-center text-muted">
            <i class="fas fa-broom fa-2x mb-3"></i>
            <p>Log display cleared. Click refresh to reload.</p>
        </div>
    `;
}

function exportLogs() {
    alert('Log export functionality will be implemented in the next update.');
}

// Add event listeners for log level filters
document.querySelectorAll('input[name="logLevel"]').forEach(radio => {
    radio.addEventListener('change', filterLogs);
});

// Load logs on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshLogs();
});
</script>
{% endblock %}
